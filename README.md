# xv6-virtual-memory

이 프로젝트는 MIT의 xv6 운영체제를 기반으로 가상 메모리 기능을 추가 구현한 것입니다. 

## 원 프로젝트 정보

이 프로젝트는 [MIT xv6](https://pdos.csail.mit.edu/6.828/2022/xv6.html) 운영체제를 기반으로 합니다. xv6는 Unix v6를 x86 아키텍처에 맞게 재구현한 교육용 운영체제입니다. 

xv6의 소스 코드는 Frans Kaashoek, Robert Morris, Russ Cox가 저작권을 갖고 있습니다. 자세한 내용은 [GitHub 저장소](https://github.com/mit-pdos/xv6-riscv)를 참조하세요.

## 추가 구현 사항

### mmap(), munmap() 시스템 콜

이 프로젝트에서는 xv6에 `mmap()`과 `munmap()` 시스템 콜을 추가로 구현했습니다. 이를 통해 파일이나 디바이스를 프로세스의 가상 주소 공간에 매핑하고 관리할 수 있습니다.

VMA(Virtual Memory Area)라는 자료구조를 도입하여 가상 메모리 영역에 대한 정보를 관리하도록 했습니다. 각 프로세스는 최대 4개까지의 VMA를 가질 수 있으며, `mmap()` 호출 시 파일 정보와 주소 정보를 바탕으로 새로운 VMA를 생성합니다.

`munmap()` 시스템 콜을 통해 `mmap()`으로 생성한 매핑을 해제할 수 있습니다. 해당 주소 범위와 정확히 일치하는 VMA를 찾아 페이지를 해제하고 VMA를 무효화합니다. 이 때 변경된 내용이 있다면 파일에 다시 기록합니다.

또한 파일을 닫을 때(`fileclose()`) 해당 파일과 연관된 모든 VMA에 대해 `munmap()`을 호출하여 자원을 정리하도록 했습니다.

### Demand Paging

이 프로젝트에서는 xv6에 Demand Paging 기능을 구현하여 메모리 사용량을 최적화했습니다. Demand Paging은 페이지에 실제 접근이 발생할 때 물리 메모리에 로드하는 기법으로, 필요한 페이지만 메모리에 유지함으로써 메모리 낭비를 줄일 수 있습니다.

먼저 페이지 폴트 핸들러를 도입하여 유효하지 않은 메모리 접근이나 권한 문제 등의 예외 상황을 처리할 수 있도록 했습니다. 또한 `mmap()`된 파일, 스택, 힙 영역 등 페이지 폴트 발생 원인에 따라 적절한 작업을 수행하도록 구현했습니다.

`mmap()`된 파일에 대한 페이지 폴트 발생 시, 물리 페이지를 할당하고 파일에서 데이터를 읽어와 가상 메모리에 매핑합니다. 스택 영역의 경우 스택 포인터를 감시하며 필요에 따라 스택을 확장하고 새 페이지를 할당합니다. 힙 영역은 `sbrk()` 호출 시점에서는 프로세스의 크기 정보만 갱신하고, 실제 메모리 할당은 페이지 폴트 발생 시점으로 지연시킵니다.

프로세스 구조체에 스택 범위 관련 필드를 추가하고, 초기화 및 힙 확장 루틴을 수정하는 등의 작업을 통해 Demand Paging을 뒷받침하는 기반을 마련했습니다. 이로써 프로세스 실행에 필요한 메모리를 보다 효율적으로 관리할 수 있게 되었습니다.
