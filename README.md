# xv6-virtual-memory

이 프로젝트는 MIT의 xv6 운영체제를 기반으로 가상 메모리 기능을 추가 구현한 것입니다. 

## 원 프로젝트 정보

이 프로젝트는 [MIT xv6](https://pdos.csail.mit.edu/6.828/2022/xv6.html) 운영체제를 기반으로 합니다. xv6는 Unix v6를 x86 아키텍처에 맞게 재구현한 교육용 운영체제입니다. 

xv6의 소스 코드는 Frans Kaashoek, Robert Morris, Russ Cox가 저작권을 갖고 있습니다. 자세한 내용은 [GitHub 저장소](https://github.com/mit-pdos/xv6-riscv)를 참조하세요.

## 프로젝트 개요
이 프로젝트는 xv6 운영체제에 다음과 같은 기능을 추가 구현하였습니다:

1. **mmap과 munmap 시스템 콜**: 파일을 프로세스의 가상 메모리에 매핑하고 관리하는 기능을 제공합니다.
2. **Demand Paging**: 실제 메모리 접근이 일어날 때 페이지를 할당하는 지연 할당 기법을 구현하여, 메모리 사용 효율을 높였습니다.

이를 통해 xv6 운영체제에서 가상 메모리를 보다 효과적으로 관리하고, 메모리 사용량을 최적화할 수 있게 되었습니다.

## 추가 구현 사항

### mmap(), munmap() 시스템 콜

mmap 시스템 콜은 파일을 프로세스의 가상 메모리에 매핑하는 기능을 제공합니다. 이를 위해 VMA(Virtual Memory Area)라는 자료구조를 도입하여, 매핑된 영역의 정보를 관리합니다. 각 프로세스는 최대 4개의 VMA를 가질 수 있으며, mmap 호출 시 새로운 VMA가 생성됩니다.

mmap 함수는 먼저 인자의 유효성을 검사하고, 가상 메모리 공간에서 매핑 가능한 영역을 찾습니다. 그 후 VMA를 생성하여 프로세스의 VMA 배열에 추가하고, 시작 주소를 반환합니다. 이 때 실제 물리 메모리 할당이나 파일 읽기는 수행하지 않습니다. (demand paging을 위함)

munmap 시스템 콜은 mmap으로 매핑한 영역을 해제합니다. 해제할 주소와 길이가 기존 VMA와 정확히 일치하는지 검사하고, 해당하는 VMA를 찾아 무효화합니다. 이 과정에서 매핑된 페이지들을 해제하고, 변경 내용이 있다면 파일에 다시 기록합니다.

또한 파일을 닫을 때(fileclose())에도 해당 파일과 연관된 모든 VMA에 대해 munmap을 호출하여 자원을 정리하도록 했습니다.

### Demand Paging
Demand paging은 페이지 폴트 핸들러를 통해 구현되었습니다. 유효하지 않은 메모리 접근이나 권한 문제 등으로 인한 페이지 폴트를 처리하고, 폴트 발생 원인에 따라 적절한 작업을 수행합니다.

mmap된 파일 영역의 폴트 발생 시, 물리 페이지를 할당하고 파일에서 데이터를 읽어와 가상 메모리에 매핑합니다.

스택 영역은 스택 포인터를 감시하며, 필요 시 스택을 아래로 확장하고 새 페이지를 할당합니다. 스택의 크기는 최대 16KB로 제한됩니다.

힙 영역의 경우, sbrk() 호출 시점에서는 프로세스의 크기 정보만 갱신하고 실제 메모리 할당은 페이지 폴트 발생 시점으로 지연시킵니다.

이를 위해 프로세스 구조체에 스택 범위 관련 필드를 추가하고, 초기화 및 힙 확장 루틴을 수정하는 등의 작업을 진행했습니다.

### 프로젝트의 의의
이 프로젝트는 운영체제의 핵심 기능 중 하나인 가상 메모리 관리에 대한 이해도를 높이고, 실제로 구현해 보는 경험을 제공합니다. mmap과 munmap, demand paging 등의 개념을 직접 구현하면서, 메모리 관리 기법의 원리와 효과를 체감할 수 있었습니다.

특히, 페이지 폴트 처리 루틴을 통해 다양한 예외 상황에 대응하는 방법을 익힐 수 있었고, 가상 메모리와 물리 메모리의 상호작용에 대해 깊이 있게 이해할 수 있었습니다. 또한 프로세스 구조체의 필드 확장, 시스템 콜과 유저 라이브러리의 연계 등 시스템 프로그래밍의 다양한 측면을 경험할 수 있었습니다.

이러한 경험은 운영체제에 대한 전문성을 키우는 데 큰 도움이 될 것입니다. 메모리 관리는 시스템의 성능과 안정성에 직결되는 주제인 만큼, 이번 프로젝트에서 얻은 지식과 경험은 효율적이고 견고한 시스템을 설계하고 구현하는 데 활용될 수 있을 것입니다.

앞으로도 운영체제의 다양한 영역에 대해 깊이 있게 탐구하고, 얻은 지식을 실제 시스템 개발에 활용하며 역량을 발전시켜 나가고자 합니다. 이 프로젝트는 그 과정에서 의미 있는 한 걸음이 될 것입니다.
